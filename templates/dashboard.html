{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block extra_css %}
<style>
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;}
  .modal.hidden{display:none;}
  .modal .content{background:#fff;padding:20px;border-radius:12px;width:360px;}
  #print-area{display:flex;gap:12px;flex-wrap:wrap;}
  #print-area>.block{flex:1 1 100%;}
  #print-area .printer-card{flex:0 0 240px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;}
</style>
{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title">üìä Dashboard</div>
  <div class="page-actions">
    <a href="{% url 'componentes-new' %}" class="btn btn-success">+ Criar componente</a>
    <a href="{% url 'produtos-new' %}" class="btn btn-primary">+ Criar produto</a>
  </div>
</div>

<div class="blocks">
  <div class="block col-4">
    <div class="stat-title">Total de componentes</div>
    <div class="stat-value">{{ total_componentes|default:"0" }}</div>
    <div class="muted" style="margin-top:6px"><a href="{% url 'estoque-componentes' %}">Ver componentes ‚Üí</a></div>
  </div>
  <div class="block col-4">
    <div class="stat-title">Total de produtos</div>
    <div class="stat-value">{{ total_produtos|default:"0" }}</div>
    <div class="muted" style="margin-top:6px"><a href="{% url 'estoque-produtos' %}">Ver produtos ‚Üí</a></div>
  </div>
  <div class="block col-4">
    <div class="stat-title">Valor total em estoque</div>
    <div class="stat-value">R$ {{ valor_total_estoque|default:"0,00" }}</div>
    <div class="muted" style="margin-top:6px">
      <a href="{% url 'estoque-componentes' %}">Componentes</a> ¬∑
      <a href="{% url 'estoque-produtos' %}">Produtos</a>
    </div>
  </div>
</div>

<div class="page-title" style="font-size:20px;margin-top:18px">‚ö†Ô∏è Estoque baixo</div>
<div class="blocks">
  <div class="block col-6">
    <div class="card-title">Componentes</div>
    <table>
      <thead><tr><th>C√≥digo</th><th>Nome</th><th class="right">Qtd</th></tr></thead>
      <tbody>
        {% if low_components %}
          {% for c in low_components %}
          <tr><td>{{ c.code }}</td><td>{{ c.name }}</td><td class="right">{{ c.inventory.qty_on_hand|default:"0" }}</td></tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="3" class="muted">Tudo ok por aqui ‚ú®</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="block col-6">
    <div class="card-title">Produtos</div>
    <table>
      <thead><tr><th>C√≥digo</th><th>Nome</th><th class="right">Qtd</th></tr></thead>
      <tbody>
        {% if low_products %}
          {% for p in low_products %}
          <tr><td>{{ p.code }}</td><td>{{ p.name }}</td><td class="right">{{ p.inventory.qty_on_hand|default:"0" }}</td></tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="3" class="muted">Tudo ok por aqui ‚ú®</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div class="page-header" style="margin-top:18px">
  <div class="page-title" style="font-size:20px">üñ®Ô∏è Andamento das impress√µes</div>
  <div class="page-actions"><button id="btn-add-printer" class="btn btn-primary">+ Adicionar impressora</button></div>
</div>
<div id="print-area">
{% if progress_items %}
  {% for item in progress_items %}
    <div class="block">
      <div class="card-title">
        {{ item.product.code }} ‚Äî {{ item.product.name }}
        <span class="badge">{{ item.total_printed|default:0 }} / {{ item.total_required|default:0 }}</span>
      </div>
      <div class="progress" title="{{ item.progress_percent|default:0|floatformat:0 }}%">
        <span style="width: {{ item.progress_percent|default:0|floatformat:0 }}%;"></span>
      </div>
      <div class="muted" style="display:flex;justify-content:space-between;margin-top:6px">
        <span>{{ item.progress_percent|default:0|floatformat:0 }}%</span>
        <span>Tempo restante: {{ item.time_remaining_hhmm|default:"‚Äî" }}</span>
      </div>
      <table style="margin-top:12px">
        <thead><tr><th>Componente</th><th class="right">Qtd impressa</th><th style="width:260px">Progresso</th><th class="right">Tempo restante</th><th>A√ß√£o</th></tr></thead>
        <tbody>
          {% for r in item.rows %}
          <tr>
            <td>{{ r.component.code }} ‚Äî {{ r.component.name }}</td>
            <td class="right">{{ r.printed|default:0|floatformat:0 }} / {{ r.required|default:0|floatformat:0 }}</td>
            <td><div class="progress"><span style="width: {{ r.progress|default:0|floatformat:0 }}%;"></span></div></td>
            <td class="right">{{ r.time_remaining_hhmm|default:"‚Äî" }}</td>
            <td><button class="btn btn-sm log-print-btn" data-order-id="{{ item.order_id }}" data-component-id="{{ r.component.id }}" data-component-name="{{ r.component.code }} ‚Äî {{ r.component.name }}" data-remaining="{{ r.remaining|default:0|floatformat:0 }}">Registrar</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}
{% else %}
  <div id="no-printing-msg" class="block"><div class="muted">Nenhuma impress√£o em andamento.</div></div>
{% endif %}
</div>
<div id="modal-log-print" class="modal hidden">
  <div class="content">
    <div class="card-title">Registrar impress√£o</div>
    <div class="form">
      {% csrf_token %}
      <div class="field">
        <label>Componente</label>
        <div id="log-print-component" class="muted">‚Äî</div>
      </div>
      <div class="field">
        <label>Quantidade</label>
        <input type="number" id="log-print-qty" value="1" min="1">
        <div id="log-print-error" class="error hidden"></div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" id="log-print-cancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="log-print-save">Adicionar</button>
      </div>
    </div>
  </div>
</div>
<div id="modal-add-printer" class="modal hidden">
  <div class="content">
    <div class="card-title">Adicionar impressora</div>
    <div class="form">
      {% csrf_token %}
      <div class="field">
        <label>Produto</label>
        <select id="add-printer-product">
          <option value="">Selecione</option>
          {% for p in products %}
          <option value="{{ p.id }}">{{ p.code }} ‚Äî {{ p.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Componente</label>
        <select id="add-printer-component"></select>
      </div>
      <div class="field">
        <label>Quantidade</label>
        <input type="number" id="add-printer-qty" value="1" min="1">
        <div id="add-printer-error" class="error hidden"></div>
      </div>
      <div class="field">
        <label>Resumo</label>
        <div id="add-printer-summary" class="muted">‚Äî</div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" id="add-printer-cancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="add-printer-add">Adicionar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
const modal=document.getElementById('modal-add-printer');
const openBtn=document.getElementById('btn-add-printer');
if(openBtn){openBtn.addEventListener('click',()=>modal.classList.remove('hidden'));}
document.getElementById('add-printer-cancel').onclick=()=>modal.classList.add('hidden');
const productSel=document.getElementById('add-printer-product');
const compSel=document.getElementById('add-printer-component');
const qtyInput=document.getElementById('add-printer-qty');
const summaryEl=document.getElementById('add-printer-summary');
const errorEl=document.getElementById('add-printer-error');
const addBtn=document.getElementById('add-printer-add');
const printArea=document.getElementById('print-area');
const csrfToken=document.querySelector('[name=csrfmiddlewaretoken]').value;
function minutesToHHMM(min){const h=Math.floor(min/60);const m=Math.round(min%60);return `${h}h${String(m).padStart(2,'0')}m`;}
function updateSummary(){const opt=compSel.options[compSel.selectedIndex];const quantity=parseInt(qtyInput.value,10);summaryEl.textContent='‚Äî';errorEl.classList.add('hidden');addBtn.disabled=true;if(!opt||!quantity){return;}const required=parseInt(opt.dataset.required,10)||0;const printTime=parseFloat(opt.dataset.printTime)||0;if(quantity>required){errorEl.textContent='Quantidade excede o total necess√°rio';errorEl.classList.remove('hidden');return;}fetch('/api/print-time/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify({component_id:opt.value,quantity})}).then(r=>r.ok?r.json():Promise.reject()).then(data=>{const remainingQty=required-quantity;const remainingMin=remainingQty*printTime;summaryEl.textContent=`Quantidade: ${quantity}; Tempo necess√°rio: ${data.time_hhmm}; Tempo restante: ${minutesToHHMM(remainingMin)}`;addBtn.disabled=false;}).catch(()=>{summaryEl.textContent='‚Äî';});}

productSel.onchange=function(){const pid=this.value;compSel.innerHTML='';summaryEl.textContent='‚Äî';errorEl.classList.add('hidden');if(!pid){return;}fetch(`/api/products/${pid}/components/`).then(r=>r.json()).then(data=>{data.forEach(c=>{const opt=document.createElement('option');opt.value=c.id;opt.textContent=`${c.code} ‚Äî ${c.name}`;opt.dataset.required=c.total_required;opt.dataset.printTime=c.print_time_min;compSel.appendChild(opt);});updateSummary();});};
compSel.onchange=updateSummary;
qtyInput.oninput=updateSummary;
addBtn.onclick=function(){
  const componentText=compSel.options[compSel.selectedIndex]?.textContent;
  const quantity=qtyInput.value;
  const summary=summaryEl.textContent;
  if(!componentText||!quantity||summary==='‚Äî')return;
  const noMsg=document.getElementById('no-printing-msg');
  if(noMsg)noMsg.remove();
  const card=document.createElement('div');
  card.className='printer-card';
  card.innerHTML=`<div class="card-title">${componentText}</div>`+
    `<div class="muted">${summary.replace(/; /g,'<br>')}</div>`;
  printArea.appendChild(card);
  modal.classList.add('hidden');
  productSel.value='';
  compSel.innerHTML='';
  qtyInput.value=1;
  summaryEl.textContent='‚Äî';
  errorEl.classList.add('hidden');
};

const logModal=document.getElementById('modal-log-print');
const logComponent=document.getElementById('log-print-component');
const logQty=document.getElementById('log-print-qty');
const logError=document.getElementById('log-print-error');
const logSave=document.getElementById('log-print-save');
const logCancel=document.getElementById('log-print-cancel');
let logData=null;
document.querySelectorAll('.log-print-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    logData={orderId:btn.dataset.orderId,componentId:btn.dataset.componentId,remaining:parseInt(btn.dataset.remaining,10)||0};
    logComponent.textContent=btn.dataset.componentName;
    logQty.value=1;
    logQty.max=logData.remaining||'';
    logError.classList.add('hidden');
    logModal.classList.remove('hidden');
  });
});
logCancel.onclick=()=>logModal.classList.add('hidden');
logSave.onclick=function(){
  const qty=parseInt(logQty.value,10);
  if(!qty||qty>logData.remaining){logError.textContent='Quantidade inv√°lida';logError.classList.remove('hidden');return;}
  fetch('/api/log-print/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify({order_id:logData.orderId,component_id:logData.componentId,quantity:qty})}).then(r=>{if(r.ok){location.reload();}else{logError.textContent='Erro ao registrar';logError.classList.remove('hidden');}}).catch(()=>{logError.textContent='Erro ao registrar';logError.classList.remove('hidden');});
};
</script>
{% endblock %}
