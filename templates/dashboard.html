{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block extra_css %}
<style>
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;}
  .modal.hidden{display:none;}
  .modal .content{background:#fff;padding:20px;border-radius:12px;width:360px;}
  #print-area{display:flex;gap:12px;flex-wrap:wrap;}
  #print-area>.block{flex:1 1 100%;}
  #print-area .printer-card{flex:0 0 240px;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px;}
</style>
{% endblock %}
{% block content %}
<div class="page-header">
  <div class="page-title">üìä Dashboard</div>
  <div class="page-actions">
    <a href="{% url 'componentes-new' %}" class="btn btn-success">+ Criar componente</a>
    <a href="{% url 'produtos-new' %}" class="btn btn-primary">+ Criar produto</a>
  </div>
</div>

<div class="blocks">
  <div class="block col-4">
    <div class="stat-title">Total de componentes</div>
    <div class="stat-value">{{ total_componentes|default:"0" }}</div>
    <div class="muted" style="margin-top:6px"><a href="{% url 'estoque-componentes' %}">Ver componentes ‚Üí</a></div>
  </div>
  <div class="block col-4">
    <div class="stat-title">Total de produtos</div>
    <div class="stat-value">{{ total_produtos|default:"0" }}</div>
    <div class="muted" style="margin-top:6px"><a href="{% url 'estoque-produtos' %}">Ver produtos ‚Üí</a></div>
  </div>
  <div class="block col-4">
    <div class="stat-title">Valor total em estoque</div>
    <div class="stat-value">R$ {{ valor_total_estoque|default:"0,00" }}</div>
    <div class="muted" style="margin-top:6px">
      <a href="{% url 'estoque-componentes' %}">Componentes</a> ¬∑
      <a href="{% url 'estoque-produtos' %}">Produtos</a>
    </div>
  </div>
</div>

<div class="page-title" style="font-size:20px;margin-top:18px">‚ö†Ô∏è Estoque baixo</div>
<div class="blocks">
  <div class="block col-6">
    <div class="card-title">Componentes</div>
    <table>
      <thead><tr><th>C√≥digo</th><th>Nome</th><th class="right">Qtd</th></tr></thead>
      <tbody>
        {% if low_components %}
          {% for c in low_components %}
          <tr><td>{{ c.code }}</td><td>{{ c.name }}</td><td class="right">{{ c.inventory.qty_on_hand|default:"0" }}</td></tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="3" class="muted">Tudo ok por aqui ‚ú®</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <div class="block col-6">
    <div class="card-title">Produtos</div>
    <table>
      <thead><tr><th>C√≥digo</th><th>Nome</th><th class="right">Qtd</th></tr></thead>
      <tbody>
        {% if low_products %}
          {% for p in low_products %}
          <tr><td>{{ p.code }}</td><td>{{ p.name }}</td><td class="right">{{ p.inventory.qty_on_hand|default:"0" }}</td></tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="3" class="muted">Tudo ok por aqui ‚ú®</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<div class="page-header" style="margin-top:18px">
  <div class="page-title" style="font-size:20px">üñ®Ô∏è Andamento das impress√µes</div>
  <div class="page-actions"><button id="btn-add-progress" class="btn btn-primary">+ Adicionar progresso</button></div>
</div>
<div id="print-area">
{% if progress_items %}
  {% for item in progress_items %}
    <div class="block">
      <div class="card-title">
        {{ item.product.code }} ‚Äî {{ item.product.name }}
        <span class="badge">{{ item.total_printed|default:0 }} / {{ item.total_required|default:0 }}</span>
      </div>
      <div class="progress" title="{{ item.progress_percent|default:0|floatformat:0 }}%">
        <span style="width: {{ item.progress_percent|default:0|floatformat:0 }}%;"></span>
      </div>
      <div class="muted" style="display:flex;justify-content:space-between;margin-top:6px">
        <span>{{ item.progress_percent|default:0|floatformat:0 }}%</span>
        <span>Tempo restante: {{ item.time_remaining_hhmm|default:"‚Äî" }}</span>
      </div>
      <table style="margin-top:12px">
        <thead><tr><th>Componente</th><th class="right">Qtd impressa</th><th style="width:260px">Progresso</th><th class="right">Tempo restante</th></tr></thead>
        <tbody>
          {% for r in item.rows %}
          <tr>
            <td>{{ r.component.code }} ‚Äî {{ r.component.name }}</td>
            <td class="right">{{ r.printed|default:0|floatformat:0 }} / {{ r.required|default:0|floatformat:0 }}</td>
            <td><div class="progress"><span style="width: {{ r.progress|default:0|floatformat:0 }}%;"></span></div></td>
            <td class="right">{{ r.time_remaining_hhmm|default:"‚Äî" }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endfor %}
{% else %}
  <div id="no-printing-msg" class="block"><div class="muted">Nenhuma impress√£o em andamento.</div></div>
{% endif %}
</div>
<div id="modal-add-progress" class="modal hidden">
  <div class="content">
    <div class="card-title">Registrar impress√£o</div>
    <div class="form">
      {% csrf_token %}
      <div class="field">
        <label>Ordem</label>
        <select id="add-progress-order">
          <option value="">Selecione</option>
          {% for op in open_orders %}
          <option value="{{ op.id }}" data-product="{{ op.product.id }}">{{ op.product.code }} ‚Äî {{ op.product.name }} ({{ op.quantity }})</option>
          {% endfor %}
        </select>
      </div>
      <div class="field">
        <label>Componente</label>
        <select id="add-progress-component"></select>
      </div>
      <div class="field">
        <label>Quantidade</label>
        <input type="number" id="add-progress-qty" value="1" min="1">
      </div>
      <div class="form-actions">
        <button type="button" class="btn" id="add-progress-cancel">Cancelar</button>
        <button type="button" class="btn btn-primary" id="add-progress-add">Adicionar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
const modal=document.getElementById('modal-add-progress');
const openBtn=document.getElementById('btn-add-progress');
if(openBtn){openBtn.addEventListener('click',()=>modal.classList.remove('hidden'));}
document.getElementById('add-progress-cancel').onclick=()=>modal.classList.add('hidden');
const orderSel=document.getElementById('add-progress-order');
const compSel=document.getElementById('add-progress-component');
const qtyInput=document.getElementById('add-progress-qty');
const csrfToken=document.querySelector('[name=csrfmiddlewaretoken]').value;
orderSel.onchange=function(){const opt=this.options[this.selectedIndex];const pid=opt?opt.dataset.product:null;compSel.innerHTML='';if(!pid){return;}fetch(`/api/products/${pid}/components/`).then(r=>r.json()).then(data=>{data.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=`${c.code} ‚Äî ${c.name}`;compSel.appendChild(o);});});};
document.getElementById('add-progress-add').onclick=function(){const orderId=orderSel.value;const componentId=compSel.value;const quantity=qtyInput.value;if(!orderId||!componentId||!quantity)return;fetch('/api/logs/',{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},body:JSON.stringify({order_id:orderId,component_id:componentId,quantity})}).then(r=>{if(r.ok)location.reload();});};
</script>
{% endblock %}
